services:
  db:
    image: postgres:16-alpine
    restart: always
    environment:
      IN_DOCKER: 1
      CI_CD: 1
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      LOCAL_POSTGRES_HOST: ${LOCAL_POSTGRES_HOST}
      LOCAL_POSTGRES_PORT: ${LOCAL_POSTGRES_PORT}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
  app:
    build:
      context: .
    volumes:
      - app-media:/files/media
      - app-static:/files/static
    environment:
      IN_DOCKER: 1
      CI_CD: 1
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT}
      LOCAL_POSTGRES_HOST: ${LOCAL_POSTGRES_HOST}
      LOCAL_POSTGRES_PORT: ${LOCAL_POSTGRES_PORT}
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
    depends_on:
      - db
    command: >
      sh -c "python manage.py wait_for_db &&
             python manage.py migrate &&
             pytest"
      

volumes:
  app-media:
  app-static:
